<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8"/>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
		<meta name="HandheldFriendly" content="true"/>
		<meta name="MobileOptimized" content="320"/>
		<title>Hello H5+</title>
		<style>
			.map-baidu{
				height: 300px;
			}
		</style>
		<script type="text/javascript" src="../js/common.js"></script>
		<link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8"/>
	</head>
	<body>
		<header id="header">
			<div class="nvbt iback" onclick="back(true);"></div>
			<div class="nvtt">XmlHttpRequest</div>
			<div class="nvbt idoc" onclick="openDoc('XmlHttpRequest Document','/doc/xhr.html')"></div>
		</header>
		<div id="dcontent" class="dcontent">
			<button onclick="alert(window.plus)">Plus</button>
			<button onclick="loadPoints('2015-12-07T16:43:33', '2015-12-07T19:54:33')">Refresh</button>
			<div id="mapContent" class="map-baidu">
				
			</div>
		</div>
		<div id="output">
XMLHttpRequest管理网络请求操作，可进行跨域网络数据请求。
		</div>
	</body>
	<script type="text/javascript" src="../js/immersed.js" ></script>
	<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=ndYEn2os3DVI5fW83tzaUkD4"></script>
	<script>
		//点集合
		var pointsList;
		//初始化
		var bMap = new BMap.Map('mapContent');
		var point = new BMap.Point(106.52335, 29.384578); //中国中心
		bMap.centerAndZoom(point, 16);
		bMap.enableScrollWheelZoom();
		bMap.addControl(new BMap.NavigationControl({anchor: BMAP_ANCHOR_TOP_LEFT}));
		var bPoint = new BMap.Point(point.lng, point.lat);
		var marker = new BMap.Marker(bPoint);
		bMap.addOverlay(marker);
		
		function loadPoints(start, end){
			//发送请求
			var xhr = new plus.net.XMLHttpRequest();
			xhr.onreadystatechange = function () {
		        switch ( xhr.readyState ) {
		            case 0:
		            	//outLine( "xhr请求已初始化" );
		            break;
		            case 1:
		            	//outLine( "xhr请求已打开" );
		            break;
		            case 2:
		            	//outLine( "xhr请求已发送" );
		            break;
		            case 3:
		                //outLine( "xhr请求已响应");
		                break;
		            case 4:
		                outLine( "xhr请求已完成");
		                if ( xhr.status == 200 ) {
		                	
		                	var res = JSON.parse(xhr.responseText);
		                	//outLine( res);
		                	//outLine( res.data);
		                	if(res.data.datastreams[0].datapoints){
		                		converPoints(res.data.datastreams[0].datapoints);
		                	}
		                } else {
		                	outLine( "xhr请求失败："+xhr.status );
		                }
		                break;
		            default :
		                break;
		        }
			};
			
			var url='http://api.heclouds.com/devices/600732/datapoints?datastream_id=gps&limit=3600&start='+start+'&end='+end;
			xhr.open( "GET", url );
			xhr.setRequestHeader('api-key', 'eLmmxmJEL56HjIfzQTeH7jqTPAo=');
			xhr.send();
		}
		
		
		
		function checkPoint(lon, lat){
			return lon > 73 && lon < 137 && lat > 1 && lat < 55;
		}
		
		function converPoints(points, callback){
			
			pointsList = points;
			
			var baiduPoints = [];
			outLine('点位个数：' + points.length);
			for(var i = 0, len = points.length, split = Math.ceil(len / 100); i < len; i++){
				var point = points[i].value;
				if(point.lat && point.lon && checkPoint(point.lon, point.lat)  && (i % split == 0) && baiduPoints.length < 100){ //最多纠偏100个点
					baiduPoints.push(point.lon + ',' + point.lat);
				}
				
			}
			outLine( "baiduPointsLength:" + baiduPoints.length);
			console.log(baiduPoints.join(';'));
			
			//纠偏
			var xhr = new plus.net.XMLHttpRequest();
			xhr.onreadystatechange = function () {
		        switch ( xhr.readyState ) {
		            case 0:
		            	//outLine( "xhr请求已初始化" );
		            break;
		            case 1:
		            	//utLine( "xhr请求已打开" );
		            break;
		            case 2:
		            	//outLine( "xhr请求已发送" );
		            break;
		            case 3:
		               // outLine( "xhr请求已响应");
		                break;
		            case 4:
		               // outLine( "xhr请求已完成");
		                if ( xhr.status == 200 ) {
		                	
		                	var res = JSON.parse(xhr.responseText);
		                	//outLine( res);
		                	//outLine( res.data);
		                	if(res.result){
		                		renderPath(res.result);
		                	}else{
		                		outSet('纠偏不成功，返回status:' + res.status);
		                	}
		                } else {
		                	outLine( "xhr请求失败："+xhr.status );
		                }
		                break;
		            default :
		                break;
		        }
			};
		
			var url='http://api.map.baidu.com/geoconv/v1/?coords=' + baiduPoints.join(';') + '&ak=ndYEn2os3DVI5fW83tzaUkD4&output=json';
			console.log(url)
			xhr.open( "GET", url );
			xhr.send();
			/*
			
			
			
			 //坐标转换完之后的回调函数
		    translateCallback = function (data){
		    	outLine( "translateCallback:" + JSON.stringify(data));
		      if(data.status === 0) {
		      	var polygonPoints = [];
		        for(var i = 0, len = data.points.length; i < len; i++){
		        	var point = new BMap.Point(data.points[i].lng, data.points[i].lat);
		        	polygonPoints.push(point);
		        	//bMap.addOverlay(new BMap.Marker(point));
		        }
		        marker.setPosition(point);
		        var polyline = new BMap.Polyline(polygonPoints, {strokeColor:"blue", strokeWeight:2, strokeOpacity:0.5});
		        bMap.addOverlay(polyline);
		        outLine( "over:"+ polygonPoints.length);
		      }
		    }
		    setTimeout(function(){
		    	outLine( "Convertor:" + BMap.Convertor);
		        var convertor = new BMap.Convertor();
		        convertor.translate(baiduPoints, 1, 5, translateCallback)
		    }, 1000);*/
		}
		function renderPath(points){
			var ppolylinePoints = [];
			outLine( "开始绘制：");
			outLine( "路径点总数："+points.length );
			console.log("路径点总数："+points.length);
	        for(var i = 0, len = points.length; i < len; i++){
	        	var point = new BMap.Point(points[i].x, points[i].y);
	        	ppolylinePoints.push(point);
	        	//bMap.addOverlay(new BMap.Marker(point));
	        }
	        marker.setPosition(point);
	        var polyline = new BMap.Polyline(ppolylinePoints, {strokeColor:"blue", strokeWeight:2, strokeOpacity:0.5});
	        bMap.addOverlay(polyline);
		}
	</script>
	
</html>